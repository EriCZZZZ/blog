---
title: "diff3"
date: 2021-04-16T17:08:35+08:00
draft: true
tags:
    - eat-too-much
---

最近在尝试看一些理论的材料然后落地其中的设计。

这种事情属实费力（因为能力太差）还没有收益（已经有完美的落地方案了），
所以打算开启一个新的系列——《吃太多》来记录学习经过。

通过这一篇可以了解到：

- diff3是什么
- 提供的保证和一些性质
- 一个简单的diff3实现

<!--more-->

{{% serial_index eat-too-much %}}

# 是什么与三向合并

diff3是一个三向合并的工具，用来合并两个基于同一个文件的修改而来的文本文件。

## 背景

实际工作中经常有多个人同时修改一个文本文件，随后合并到一起的场景，
用来解决这种问题有两种思路：基于操作的合并和基于状态的合并。

基于操作的合并通过追踪全部的修改操作，然后尝试构造出一个统一的视图。

相反地，基于状态的合并，只需要关注文本的当前状态，然后得出一个统一的状态。
一个关键的难点是如何将不同版本之间的数据“对齐(align)”。
如果数据是结构化的、有key的，“对齐”的规则（用key来对齐）是清晰的；
而对于更富变化性的数据，比如文本，或者抽象的讲，列表的内容，
因为没有天然的对齐锚点，进行“对齐”更加困难。

# diff3

`diff3`是一个基于状态的合并工具，
支持输入两个需要合并的版本和一个旧版本来输出合并的结果。

## 定义

首先给出原子对象$\mathcal{A}$的集合。
从实现上来看，原子对象是合并操作的不可分的对象，通常是文本的一行。

有$\mathcal{A}^\*$来表示$\mathcal{A}$中的元素组成的列表的集合，
用$J,K,L,O,A,B,C$来表示$\mathcal{A}^\*$中的元素。
下文称之为**序列**。

对于列表$J$，有$J[k]$表示$J$中的第$k$个元素，
有$J[i..j]$表示$J$中的一个**片段(_span_)**，是闭区间。

定义 **配置(_configuration_)** 是
三元组$(A,O,B)\in\mathcal{A}^\* \times \mathcal{A}^\* \times \mathcal{A}^\*$。
特别的，$\mathcal{A},\mathcal{B}$是从$\mathcal{O}$派生出来的。

定义 **同步器(_synchronizer_)** 是一个函数，
接受 一个**配置**，输出另一个**配置**。
**同步器**的一次 **运行(_run_)** 表示为$(A,O,B)\rightarrow(A',O',B')$。
特别的，如果输出的三个相等，那么称这次 **运行** 为 **无冲突的(_conflict-free_)**，
表示为 $(A,O,B)\rightarrow C$ 。

## 根据直觉的描述

diff3首先调用两路比较来比较$(O,A)$和$(O,B)$来生成两个 **不交叉匹配(_non-crossing matching_)** ：$M_A,M_B$。

**不交叉匹配**是一个布尔函数，接受两个参数分别是两个序列的下标，
如果有$M_A(i,j)=true$，那么：

1. $O[i]=A[j]$
1. 对于任意的$i' \neq i$ 和 $j' \neq j$ ，有 $M_A[i',j] = M_A[i,j'] = false$
1. 如果有 $i' > i  \land j' < j$ 或 $i' < i  \land j' > j$，则$M_A[i',j'] = false$

直觉的看，如果两个序列有两个元素匹配，那么两个元素唯一匹配且两个元素的前后不会匹配。
这样可以简单的通过递归实现。

特别的，在diff3的实现中，认为生成**匹配**的**两路比较**函数是一个黑盒，具有稳定性和最大匹配的特性。


## diff3的功能与表现

# 参考

- [diff3 wiki](https://en.wikipedia.org/wiki/Diff3)
- [A formal investigation of Diff3](http://www.cis.upenn.edu/~bcpierce/papers/diff3-short.pdf)
