---
title: "CRDT"
date: 2021-03-05T10:59:43+08:00
draft: true
tags:
    - distributed
    - data_struct
    - what
---

CRDT *(Conflict-free Replicated Data Types)* 是一种数据结构，能够在AP的情况下，提供数据的最终一致性。

对于CRDT有两种等价的描述，分别是基于状态(state-based)的和基于操作的(operation-based)。

# CRDT论文笔记

## 概念与定义

- 表示集群的集合与正确的

    定义一个有限集合，其中的元素为无拜占庭问题的进程。
    其中的进程会：
    
    1. 随机、无预警的崩溃(crash)
    1. 永久的崩溃
    1. 保留所有状态恢复

    对于没有崩溃的元素称为 **正确的** (correct)。

## 基于状态的描述 state-based

设想我们维护一个对象，
在集群上，每个进程有一个这个对象的副本。
具体的，对象是一个元组 $(S,s^0,q,u,m)$ 。

每个进程 $p\_i$ 有自己的对象，和自己的状态 $s\_i \in S$，
其中 $s\_i$ 被称为 **载荷** (payload)。
**载荷** 的初始值是 $s^0$ 。

$q$ $u$ $m$ 是对象的**方法** (method)，
对象的用户会用 query $q$ 来查询状态，
用 update $u$ 来更新状态，
merge $m$ 用来合并两个副本。
方法都是在单个副本上执行的。

系统运行时，会通过容错的方法将所有副本上的所有更新投递给所有的副本，
一个副本在接收到其他副本的更新消息时，
通过 $merge$ 来合并。

### 一些定义和解释

- 一个方法的所有前提被满足的状态被称为 **启用的** (enable)。一个启用的方法会在被调用时尽快执行。

- 方法的排序
    - 定义 $f^k\_i(a)$ 是在副本 $i$ 上执行的第 $k$ 个方法，排序从1开始。
    - 定义 $K\_i(f)$ 是方法 $f$ 在副本 $i$ 上执行的序号。

    有 $K_i(f^k_i(a)) = k$ 成立。

- 状态的变更
    - 定义 $s^k\_i$ 是副本 $i$ 在第$k$个方法执行完成后的状态，特别的 $s^0\_i=s^0$。

    我们将第$k$个方法在副本$i$上的执行和状态的变化表示为：
    
    $$
    s^{k-1}_i \cdot f^k_i(a) = s^k_i
    $$
- 如果两个状态对于任何查询方法调用返回相同的结果，那么称这两个状态为**相等**(equivalence)。

- **因果关系史** (Casual History)

    对于一个对象（指全系统所有副本的聚合体），有自己的**因果关系史**。
    定义**因果关系史**为一个集合：

    $$
    C = [c_1,...,c_n]
    $$

    其中，$c_i$ 是一个序列，表示节点$i$的因果关系史，
    从$c^0_i$依次转化为$c^k_i$。

    对于三种操作，变化如下：

    - 查询$q$对因果关系史不产生影响，即如果第$k$操作是查询操作，则$c^{k-1}\_i = c^k\_i$成立。
    - 更新$u$将更新的结果并入因果关系史，对于$u^k\_i(a)$，有$c^k\_i=c^{k-1}\_i \cup \{ {u^k\_i(a)} \}$成立。
    - 合并$m$将两个因果关系史合并，对于 $m^k\_i(s^{k^{\prime}}\_{i^{\prime}})$，
        有$c^k\_i=c^{k-1}\_{i-1} \cup c^{k^{\prime}}\_{i^{\prime}}$成立。

- 如果一个更新已经被包括在因果关系史中，那么称为**已投递**(delivered)。
- 对于更新$u$和更新$u^'$，如果当$u^'$执行的时候，如果$u$已经在因果关系史中，
    那么称$u$**先行发生**(happen-before)于$u^'$。
- 两个更新如果互相不先行发生于对方，那么称这两个更新是**并行的**(concurrent)。

基于“容错的网络”，我们可以推定，每一个更新最终都会被每一个副本得知。
但是不能保证所有副本会汇聚到同一个状态。

为了解决这个问题，我们先给出**强最终一致性**的定义。

## **强最终一致性** (Strong Eventual Consistency)

首先给出**最终一致性**的定义：

- **最终投递** (Eventual Consistency) 任何一个投递到**正确的**副本的更新，最后都会被投递到所有的**正确的**副本上。
- **汇聚性** (Converagence) 对于任意两个**正确的**副本，如果有相同的更新集合被投递，最后两者会达到**相等的**状态。
- **终止性** (Termination) 所有的**方法**会执行终止。

如果有一个更新被并行的执行在**最终一致性**的两个副本上，
通常每个副本会立即执行更新，
随后通过其他手段发现冲突并解决。

为了（在满足**汇聚性**的条件下）解决这种冲突，需要让多个副本之间达成一个共识，这是一个十分消耗资源的操作。

为了解决这种情况，我们增加了一个条件来构成**强最终一致性**：

- **强汇聚性** 对于投递了相同更新的两个**正确的**副本，会达到**相等的**状态。






# 参考资料

- [Conflict-free Replicated Data Types](https://hal.inria.fr/hal-00932836/file/CRDTs_SSS-2011.pdf)











